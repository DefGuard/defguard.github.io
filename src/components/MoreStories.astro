---
import type { CollectionEntry } from "astro:content";

interface Props {
  currentSlug: string;
  posts: CollectionEntry<"blog">[];
}

const { currentSlug, posts } = Astro.props;

// Default fallback image
const defaultImage = "/images/png/defguard.png";

// Get image for a post
const getPostImage = (post: CollectionEntry<"blog">) => {
  return post.data.image || defaultImage;
};

// Format date function
const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

// Truncate description
const truncateDescription = (text: string, maxLength: number = 100) => {
  if (text.length <= maxLength) return text;
  return text.slice(0, maxLength).trim() + "...";
};

// Filter out current post and get 3 random posts
const otherPosts = posts.filter((post) => post.slug !== currentSlug);
const selectedPosts = otherPosts.sort(() => Math.random() - 0.5).slice(0, 3);
---

<section class="more-stories">
  <div class="container">
    <p class="section-title">More Stories</p>
    <div class="posts-grid">
      {
        selectedPosts.map((post) => (
          <article class="post-card">
            <a href={`/blog/${post.slug}`} class="post-card-link">
              <div class="post-image-wrapper">
                <img 
                  src={getPostImage(post)} 
                  alt={post.data.title}
                  loading="lazy"
                  class="post-image"
                />
                {post.data.companyName && (
                  <span class="card-badge-case-study">Case Study</span>
                )}
              </div>
              <div class="post-content">
                <h3 class="post-title">{post.data.title}</h3>
                <p class="post-description">{truncateDescription(post.data.description)}</p>
                <div class="post-meta">
                  <time datetime={post.data.publishDate.toISOString()}>
                    {formatDate(post.data.publishDate)}
                  </time>
                </div>
              </div>
            </a>
          </article>
        ))
      }
    </div>
  </div>
</section>

<style lang="scss">
  .more-stories {
    padding: 4rem 0;
    background-color: #f5f5f5;

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .section-title {
      margin: 0 0 2rem;
      font-size: calc(1.1rem * var(--font-scale-factor));
      font-weight: 500;
      color: var(--text-body-primary);
      text-align: left;
    }

    .posts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;

      @media (min-width: 640px) {
        grid-template-columns: repeat(2, 1fr);
        gap: 28px;
      }

      @media (min-width: 1024px) {
        grid-template-columns: repeat(3, 1fr);
        gap: 32px;
      }
    }

    .post-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      transition: transform 0.25s ease, box-shadow 0.25s ease;

      &:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);

        .post-image {
          transform: scale(1.05);
        }

        .post-title {
          color: var(--primary-button-bg, #0c8ce0);
        }
      }

      .post-card-link {
        display: block;
        text-decoration: none;
        color: inherit;
      }

      .post-image-wrapper {
        position: relative;
        overflow: hidden;
        background: #f8f8f8;
      }

      .post-image {
        width: 100%;
        height: auto;
        display: block;
        transition: transform 0.4s ease;
      }

      .card-badge-case-study {
        position: absolute;
        top: 12px;
        left: 12px;
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.95);
        color: #166534;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 4px;
        backdrop-filter: blur(4px);
      }

      .post-content {
        padding: 1.25rem;
      }

      .post-title {
        margin: 0 0 0.75rem;
        font-size: 1.1rem;
        font-weight: 500;
        line-height: 1.4;
        color: var(--text-body-primary);
        transition: color 0.2s ease;
        
        // Clamp to 2 lines
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .post-description {
        margin: 0 0 1rem;
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--text-body-secondary, #666);
        font-weight: 300;
        
        // Clamp to 2 lines for more stories
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .post-meta {
        display: flex;
        align-items: center;
        font-size: 12px;
        color: var(--text-body-secondary, #888);

        time {
          font-weight: 400;
        }
      }
    }
  }
</style>
