---
import { getCollection } from "astro:content";
import Navigation from "../../components/base/Navigation.astro";
import ProductLayout from "../../layouts/ProductLayout.astro";
import ShareButtons from "../../components/ShareButtons.astro";
import MoreStories from "../../components/MoreStories.astro";
import BlogArticleJSONLD from "../../scripts/BlogArticleJSONLD.astro";

export async function getStaticPaths() {
  const blogEntries = await getCollection("blog");
  return blogEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry, allPosts: blogEntries },
  }));
}

// Get the blog entry from the props
const { entry, allPosts } = Astro.props;

// Get the rendered content
const { Content } = await entry.render();

// Format the publication date
const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

// Calculate word count for schema
const getWordCount = (body: string) => {
  const plainText = body
    .replace(/```[\s\S]*?```/g, '')
    .replace(/`[^`]*`/g, '')
    .replace(/\[([^\]]*)\]\([^)]*\)/g, '$1')
    .replace(/[#*_~>\-]/g, '')
    .replace(/<[^>]*>/g, '')
    .replace(/import\s+.*?from\s+['"][^'"]*['"]/g, '')
    .replace(/\{[^}]*\}/g, '');
  return plainText.split(/\s+/).filter(word => word.length > 0).length;
};

const wordCount = getWordCount(entry.body);
const title = `${entry.data.seoTitle || entry.data.title} | Defguard Blog`;
const description = entry.data.description;
const url = `https://defguard.net/blog/${entry.slug}`;

// Get image from frontmatter or extract from content
const content = entry.body;
const imageMatch = content.match(/!\[.*?\]\((.*?)\)/);
// Fix image URL construction - don't double-prefix with domain
const imageUrl = entry.data.image
  ? (entry.data.image.startsWith('http') ? entry.data.image : `https://defguard.net${entry.data.image}`)
  : imageMatch
    ? (imageMatch[1].startsWith('http') ? imageMatch[1] : `https://defguard.net${imageMatch[1]}`)
    : "https://defguard.net/images/png/defguard.png";

// Generate relevant tags for blog post
const blogTags = [
  "defguard",
  "blog",
  "cybersecurity",
  "vpn",
  "zero-trust",
  ...(entry.data.tags || []),
];

// Check if case study metadata exists
const hasCaseStudy =
  entry.data.companyName && entry.data.companyDescription && entry.data.companyWebsite;
---

<ProductLayout
  title={title}
  description={description}
  url={url}
  featuredImage={imageUrl}
  imageWidth="1200"
  imageHeight="630"
  tags={blogTags}
>
  <!-- Blog-specific meta tags -->
  <meta slot="schema" property="og:type" content="article" />
  <meta slot="schema" property="article:published_time" content={entry.data.publishDate.toISOString()} />
  {entry.data.author && <meta slot="schema" property="article:author" content={entry.data.author} />}
  <meta slot="schema" property="article:section" content="Technology" />
  {blogTags.map(tag => <meta slot="schema" property="article:tag" content={tag} />)}
  
  <!-- Structured Data for Blog Post -->
  <BlogArticleJSONLD
    slot="schema"
    title={entry.data.title}
    description={description}
    url={url}
    image={imageUrl}
    datePublished={entry.data.publishDate.toISOString()}
    author={entry.data.author}
    tags={blogTags}
    wordCount={wordCount}
  />
  
  <Navigation activeSlug="/blog/" />

  <main id="blog-post-page">
    <article class="blog-post">
      <div class="container">
        <div class="content-wrapper">
          <div class="share-column">
            {
              hasCaseStudy && (
                <div class="case-study-info">
                  <p class="label">Company</p>
                  <h3>{entry.data.companyName}</h3>
                  <p>{entry.data.companyDescription}</p>
                  {entry.data.companySegment && (
                    <div class="company-segment">
                      <p class="label">Industry</p>
                      <p>{entry.data.companySegment}</p>
                    </div>
                  )}
                  <a
                    href={entry.data.companyWebsite}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="company-website"
                  >
                    {entry.data.companyWebsite}
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="9"
                      height="9"
                      viewBox="0 0 12 13"
                      fill="none"
                    >
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M0 0.5H4V1.83333H1.33333V11.1667H10.6667V8.5H12V12.5H0V0.5ZM9.72386 1.83333H7.77778V0.5H12V4.72222H10.6667V2.77614L6.4714 6.9714L5.5286 6.0286L9.72386 1.83333Z"
                        style={{ fill: "var(--text-body-primary)" }}
                      />
                    </svg>
                  </a>
                </div>
              )
            }
            <ShareButtons url={url} title={entry.data.title} />
          </div>

          <div class="main-content">
            <header class="post-header">
              <h1>{entry.data.title}</h1>
              <div class="post-meta">
                <time datetime={entry.data.publishDate.toISOString()}>
                  {formatDate(entry.data.publishDate)}
                </time>
                {
                  entry.data.author && (
                    <span class="post-author">by {entry.data.author}</span>
                  )
                }
              </div>
            </header>

            <div class="post-content">
              <Content />
            </div>

            <footer class="post-footer">
              <div class="post-navigation">
                <a href="/blog" class="back-to-blog">‚Üê Back to Blog</a>
              </div>
              <div class="post-cta"><p>Ready to secure your private cloud?</p></div>
              <div class="post-cta-buttons">
                <a
                  href={`/pricing?utm_source=blog&utm_medium=post&utm_campaign=${entry.slug}#get-evaluation-license`}
                  class="book-demo-button">Get Evaluation License</a
                >
                <a
                  href={`/book-a-demo?utm_source=blog&utm_medium=post&utm_campaign=${entry.slug}`}
                  class="book-demo-button">Book a Demo</a
                >
              </div>
            </footer>
          </div>
        </div>
      </div>
    </article>
  </main>

  <MoreStories currentSlug={entry.slug} posts={allPosts} />
  
  <!-- Image Lightbox -->
  <div id="image-lightbox" class="lightbox">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightbox-img" alt="" />
    <div class="lightbox-caption" id="lightbox-caption"></div>
  </div>
</ProductLayout>

<script>
  // Image lightbox functionality
  document.addEventListener('DOMContentLoaded', () => {
    const lightbox = document.getElementById('image-lightbox');
    const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
    const lightboxCaption = document.getElementById('lightbox-caption');
    const closeBtn = document.querySelector('.lightbox-close');
    
    // Get all images in post content (excluding hero images in header)
    const postContent = document.querySelector('.post-content');
    if (postContent) {
      const images = postContent.querySelectorAll('img');
      
      images.forEach((img) => {
        // Add cursor pointer to indicate clickable
        img.style.cursor = 'pointer';
        
        img.addEventListener('click', () => {
          if (lightbox && lightboxImg && lightboxCaption) {
            lightbox.style.display = 'flex';
            lightboxImg.src = img.src;
            lightboxImg.alt = img.alt;
            lightboxCaption.textContent = img.alt || '';
            // Prevent body scroll when lightbox is open
            document.body.style.overflow = 'hidden';
          }
        });
      });
    }
    
    // Close lightbox
    const closeLightbox = () => {
      if (lightbox) {
        lightbox.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    };
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closeLightbox);
    }
    
    if (lightbox) {
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          closeLightbox();
        }
      });
    }
    
    // Close on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLightbox();
      }
    });

    // Add anchors to headers
    const addAnchorsToHeaders = () => {
      const postContent = document.querySelector('.post-content');
      if (!postContent) return;

      // Function to generate a slug from text
      const slugify = (text: string): string => {
        return text
          .toLowerCase()
          .trim()
          .replace(/[^\w\s-]/g, '') // Remove special characters
          .replace(/[\s_-]+/g, '-') // Replace spaces and underscores with hyphens
          .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
      };

      // Find all headers (h1-h4) in post content
      const headers = postContent.querySelectorAll('h1, h2, h3, h4');
      
      headers.forEach((header) => {
        const text = header.textContent || '';
        if (!text.trim()) return;

        // Generate ID from header text
        let id = slugify(text);
        
        // Ensure unique IDs (in case of duplicate headers)
        let counter = 1;
        let uniqueId = id;
        while (document.getElementById(uniqueId)) {
          uniqueId = `${id}-${counter}`;
          counter++;
        }
        id = uniqueId;

        // Set the ID on the header
        header.id = id;

        // Create anchor link
        const anchor = document.createElement('a');
        anchor.href = `#${id}`;
        anchor.className = 'header-anchor';
        anchor.setAttribute('aria-label', `Link to ${text}`);
        anchor.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>';
        
        // Insert anchor link before header text
        header.insertBefore(anchor, header.firstChild);
      });
    };

    addAnchorsToHeaders();
  });
</script>

<style lang="scss">
  // Removed global overflow overrides that were interfering with sticky positioning

  .label {
    margin: unset !important;
    font-size: calc(0.8rem * var(--font-scale-factor)) !important;
    color: var(--text-body-secondary) !important;
  }

  #blog-post-page {
    padding-top: var(--nav-height);
    background-color: white;
    position: relative;
    min-height: 100vh;
    overflow: unset;

    .blog-post {
      padding: 2rem 0 4rem;
      position: relative;
      @include break-down(md) {
          padding: 1rem 0 1rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        position: relative;
        overflow: unset;
      }

      .content-wrapper {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
        position: relative;
        overflow: unset;
      }

      .share-column {
        width: 200px;
        flex-shrink: 0;
        position: -webkit-sticky;
        position: sticky;
        top: calc(var(--nav-height) + 2rem);
        margin-top: 210px;
        height: fit-content;
        z-index: 2;
        transform: translate3d(0, 0, 0);
        @include break-down(md) {
          margin: 20px;
        }
      }

      .case-study-info {
        margin-bottom: 2rem;
        padding-bottom: 2rem;

        h3 {
          font-size: calc(1rem * var(--font-scale-factor));
          font-weight: 500;
          color: var(--text-body-primary);
          margin: 0 0 0.5rem;
        }

        p {
          font-size: calc(1.1rem * var(--font-scale-factor));
          line-height: 1.5;
          color: var(--text-body-primary);
          margin: 0 0 1rem;
          text-align: justify;
        }

        .company-segment {
          margin-bottom: 1rem;

          p {
            margin: 0;
          }
        }

        .company-website {
          display: inline-flex;
          align-items: center;
          gap: 5px;
          color: var(--primary-color);
          text-decoration: none;
          font-size: calc(0.9rem * var(--font-scale-factor));

          &:hover {
            text-decoration: underline;
          }

          svg {
            width: 9px;
            height: 9px;
          }
        }
      }

      .main-content {
        flex: 1;
        max-width: 800px;
        position: relative;
      }

      .post-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color, #eaeaea);

        h1 {
          margin-top: 0;
          margin-bottom: 1rem;
          font-size: calc(2.5rem * var(--font-scale-factor));
          line-height: 1.2;
          font-weight: 400;
          color: var(--text-body-primary);
        }
      }

      .post-meta {
        display: flex;
        flex-wrap: wrap;
        color: var(--text-body-secondary, var(--text-body-primary));
        margin-bottom: 1rem;

        time {
          margin-right: 0.5rem;
        }

        .post-author {
          margin-left: 0.5rem;
        }
      }

      .post-content {
        margin-bottom: 3rem;

        :global(hr) {
          border: 1px solid var(--border-color, #eaeaea);
          margin: 2rem 0;
        }

        /* Global table styles for Markdown tables */
        :global(table) {
          width: 100%;
          border-collapse: collapse;
          margin: 2rem 0;
          font-size: 0.9rem;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          border-radius: 8px;
          overflow: hidden;
          border: 1px solid #e0e0e0;
        }

        :global(thead) {
          background-color: #f8f9fa;
        }

        :global(th),
        :global(td) {
          padding: 12px 16px;
          border-bottom: 1px solid #dee2e6;
          text-align: left;
          vertical-align: top;
        }

        :global(th) {
          font-weight: 600;
          color: var(--text-body-primary);
        }

        :global(td) {
          color: var(--text-body-primary);
        }

        /* Zebra striping for better readability */
        :global(tbody tr:nth-child(even)) {
          background-color: #fdfdfd;
        }

        /* Remove bottom border for last row */
        :global(tbody tr:last-child td) {
          border-bottom: none;
        }

        /* Make table responsive with scroll */
        :global(.table-wrapper) {
          width: 100%;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          margin: 2rem 0;
        }

        :global(.table-wrapper table) {
          margin: 0;
          border: none;
          box-shadow: none;
        }

        :global(h1),
        :global(h2),
        :global(h3),
        :global(h4) {
          position: relative;
          scroll-margin-top: calc(var(--nav-height) + 1rem);
        }

        :global(h1) {
          font-size: calc(2.25rem * var(--font-scale-factor));
          margin: 2rem 0 1rem;
          font-weight: 400;
          color: var(--text-body-primary);
        }

        :global(h2) {
          font-size: calc(1.75rem * var(--font-scale-factor));
          margin: 1.75rem 0 1rem;
          font-weight: 400;
          color: var(--text-body-primary);
        }

        :global(h3) {
          font-size: calc(1.5rem * var(--font-scale-factor));
          margin: 1.5rem 0 1rem;
          font-weight: 400;
          color: var(--text-body-primary);
        }

        :global(h4) {
          font-size: calc(1.25rem * var(--font-scale-factor));
          margin: 1.25rem 0 0.75rem;
          font-weight: 400;
          color: var(--text-body-primary);
        }

        :global(.header-anchor) {
          position: absolute;
          left: -1.5rem;
          top: 50%;
          transform: translateY(-50%);
          opacity: 0;
          transition: opacity 0.2s ease;
          color: var(--primary-color, #0c8ce0);
          text-decoration: none;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 1.2rem;
          height: 1.2rem;
          
          svg {
            width: 100%;
            height: 100%;
          }

          &:hover {
            opacity: 1 !important;
            color: var(--primary-color, #0c8ce0);
          }

          &:focus {
            opacity: 1;
            outline: 2px solid var(--primary-color, #0c8ce0);
            outline-offset: 2px;
            border-radius: 2px;
          }
        }

        :global(h1:hover .header-anchor),
        :global(h2:hover .header-anchor),
        :global(h3:hover .header-anchor),
        :global(h4:hover .header-anchor) {
          opacity: 0.6;
        }

        @media (max-width: 768px) {
          :global(.header-anchor) {
            left: -1.2rem;
            width: 1rem;
            height: 1rem;
          }
        }

        :global(p) {
          margin: 1rem 0;
          line-height: 1.6;
          font-weight: 300;
          color: var(--text-body-primary);
          font-size: calc(1.2rem * var(--font-scale-factor));
        }

        :global(ul),
        :global(ol) {
          margin: 1rem 0;
          padding-left: 1.5rem;

          :global(li) {
            margin-bottom: 0.5rem;
            line-height: 1.6;
            font-weight: 300;
            color: var(--text-body-primary);
            font-size: calc(1rem * var(--font-scale-factor));
          }
        }

        :global(blockquote) {
          border-left: 4px solid var(--primary-color, #0c8ce0);
          padding-left: 1rem;
          margin: 1.5rem 0;
          font-weight: 300;
          color: var(--text-body-secondary, var(--text-body-primary));
        }

        :global(a) {
          color: var(--primary-color, #0c8ce0);
          text-decoration: none;
          font-weight: inherit;

          &:hover {
            text-decoration: underline;
          }
        }

        :global(pre) {
          background: var(--code-bg, #fff);
          padding: 1rem;
          border-radius: 4px;
          overflow-x: auto;
          margin: 1.5rem 0;
          font-size: 0.95em;
        }

        :global(pre code) {
          font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
          font-size: 0.95em;
          font-weight: 400;
          background: transparent;
          padding: 0;
          border-radius: 0;
        }

        :global(code) {
          font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
          font-size: 0.9em;
          font-weight: 400;
          background: var(--code-bg, #fff);
          padding: 0.2em 0.4em;
          border-radius: 3px;
        }

        /* Table styles matching the comparison page */
        :global(.table-container) {
          width: 100%;
          overflow-x: auto;
          margin: 2rem auto;
          max-width: 80ch;
        }

        :global(.comparison-table) {
          width: 100%;
          border-collapse: collapse;
          font-size: 0.95rem;
          table-layout: fixed;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          overflow: hidden;
          background: transparent;
          
          th, td {
            text-align: left;
            padding: 16px 12px;
            border: 1px solid #e0e0e0;
            vertical-align: top;
          }
          
          th {
            font-weight: 600;
            background: transparent;
            border-bottom: 1px solid #e0e0e0;
            color: var(--text-body-primary);
          }
          
          td:first-child {
            font-weight: 600;
            width: 20%;
            color: var(--text-body-primary);
          }
          
          td:nth-child(2),
          td:nth-child(3),
          td:nth-child(4) {
            width: 26.67%;
          }
          
          td {
            overflow-wrap: break-word;
            hyphens: auto;
            color: var(--text-body-primary);
          }
        }

        /* Markdown image styling */
        :global(img) {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 2.5rem auto;
          border-radius: 4px;
          box-shadow: var(--box-shadow, 0 4px 8px rgba(0, 0, 0, 0.08));
        }
      }

      .post-footer {
        padding-top: 1.5rem;
        //border-top: 1px solid var(--border-color, #eaeaea);

        .post-navigation,
        .post-cta-buttons {
          display: flex;
          justify-content: space-between;
          align-items: center;

          .back-to-blog {
            color: var(--primary-text-color);
            font-weight: 400;
            text-decoration: none;
            &:hover {
              text-decoration: underline;
            }
          }

          .book-demo-button {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            color: var(--text-body-primary);
            text-decoration: none;
            border-radius: 100px;
            font-weight: 300;
            transition: border 0.2s ease;
            border: 1px solid var(--text-body-primary);
            margin: 0.5rem 0;
            font-size: calc(1.5rem * var(--font-scale-factor));

            &:hover {
              border: 1px solid var(--primary-button-bg, #0c8ce0);
              text-decoration: none;
            }
          }
        }

        .post-cta {
          border-top: 1px solid var(--primary-button-bg, #0c8ce0);
          padding-top: 2rem;
          p {
            text-align: center;
          }
        }
        .post-cta-buttons {
          padding: 2rem 0 1rem 0;
          justify-content: center; //or space-between?
          gap: 40px;
          @include break-down(md) {
            display: block;
            text-align: center;
            .book-demo-button {
              font-size: calc(1.2rem * var(--font-scale-factor));
            }
          }
        }
        .post-navigation {
          padding-bottom: 2rem;
        }
      }
    }
  }

  @include break-down(md) {
    #blog-post-page {
      .blog-post {
        .content-wrapper {
          flex-direction: column;
        }

        .share-column {
          position: static;
          width: 100%;
          //max-width: 640px;
          order: 1;
          margin-bottom: 2rem;
          padding: 0;
          margin-left: unset;

        }

        .case-study-info {
          text-align: left;
          margin-bottom: 1rem;
          padding-bottom: 1rem;
        }
      }
    }
  }

  /* Image Lightbox Styles */
  .lightbox {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    justify-content: center;
    align-items: center;
    flex-direction: column;
    padding: 20px;
    
    .lightbox-content {
      max-width: 95%;
      max-height: 85vh;
      width: auto;
      height: auto;
      object-fit: contain;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      margin: 0;
    }
    
    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 40px;
      color: #fff;
      font-size: 48px;
      font-weight: 300;
      cursor: pointer;
      transition: color 0.2s ease;
      line-height: 1;
      user-select: none;
      
      &:hover {
        color: var(--primary-button-bg, #0c8ce0);
      }
    }
    
    .lightbox-caption {
      color: #fff;
      text-align: center;
      padding: 15px;
      max-width: 800px;
      font-size: 16px;
      margin-top: 15px;
    }
  }
</style>
