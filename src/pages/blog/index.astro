---
import { getCollection } from "astro:content";
import Navigation from "../../components/base/Navigation.astro";
import ProductLayout from "../../layouts/ProductLayout.astro";
import FlexibleSection from "../../components/FlexibleSection.astro";
import BlogListJSONLD from "../../scripts/BlogListJSONLD.astro";
import { blogFilterTags } from "../../data/blog-filter-tags";

// Get all blog posts, sorted by date
const allPosts = await getCollection("blog", ({ data }) => {
  return import.meta.env.DEV || !data.draft;
});

// Sort posts by date in descending order (newest first)
const sortedPosts = allPosts.sort(
  (a, b) =>
    new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf(),
);

// Filter pills: show all configured tags in config order (so edits to blogFilterTags are visible immediately)
const allTags = [...blogFilterTags];

// Default fallback image for posts without images
const defaultImage = "/images/png/defguard.png";

// Get image for a post (from frontmatter or fallback)
const getPostImage = (post: typeof sortedPosts[0]) => {
  return post.data.image || defaultImage;
};

// Estimate reading time from post body (~200 words per minute)
const getReadingTime = (body: string) => {
  // Strip MDX/markdown syntax for more accurate word count
  const plainText = body
    .replace(/```[\s\S]*?```/g, '') // Remove code blocks
    .replace(/`[^`]*`/g, '') // Remove inline code
    .replace(/\[([^\]]*)\]\([^)]*\)/g, '$1') // Convert links to text
    .replace(/[#*_~>\-]/g, '') // Remove markdown syntax
    .replace(/<[^>]*>/g, '') // Remove HTML tags
    .replace(/import\s+.*?from\s+['"][^'"]*['"]/g, '') // Remove imports
    .replace(/\{[^}]*\}/g, ''); // Remove JSX expressions
  
  const wordCount = plainText.split(/\s+/).filter(word => word.length > 0).length;
  const minutes = Math.max(1, Math.ceil(wordCount / 200));
  return `${minutes} min read`;
};

const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

const title = "Enterprise VPN & Zero-Trust Security Blog | Defguard";
const description = "Expert guides on WireGuard® VPN, MFA implementation, and NIS2 compliance. Real-world case studies, security tutorials, and best practices for self-hosted enterprise infrastructure.";
const url = "https://defguard.net/blog";
const blogTags = ["defguard", "blog", "vpn", "wireguard", "cybersecurity", "enterprise security", "zero-trust", "sso"];
---

<ProductLayout
  title={title}
  description={description}
  url={url}
  featuredImage="https://defguard.net/images/png/defguard.png"
  imageWidth="1080"
  imageHeight="540"
  tags={blogTags}
>
  <!-- Blog List Structured Data -->
  <BlogListJSONLD 
    slot="schema"
    posts={sortedPosts.map(post => ({
      slug: post.slug,
      title: post.data.title,
      description: post.data.description,
      publishDate: post.data.publishDate,
      image: post.data.image,
      author: post.data.author
    }))}
  />
  
  <Navigation activeSlug="/blog/" />

  <main id="blog-page">
    <FlexibleSection
      title="Enterprise VPN & Security Insights"
      titleTag="h1"
      id="blog-header"
      variant="white"
      theme="light"
    >
      <div slot="left">
        <p>
          Expert guides on WireGuard® VPN deployment, MFA implementation, 
          and building zero-trust infrastructure for enterprise environments.
        </p>
      </div>

      <div slot="right">
        <p>
          Real-world case studies, NIS2 compliance tutorials, and security 
          best practices from the team behind the open-source Defguard platform.
        </p>
      </div>
    </FlexibleSection>

    <section class="blog-posts-listing">
      <div class="container">
        {sortedPosts.length > 0 && allTags.length > 0 && (
          <div class="blog-tag-filter" role="group" aria-label="Filter by tag">
            <button type="button" class="filter-pill active" data-tag="">All</button>
            {allTags.map((tag) => (
              <button type="button" class="filter-pill" data-tag={tag}>{tag}</button>
            ))}
          </div>
        )}
        {
          sortedPosts.length === 0 ? (
            <div class="no-posts">
              <p>No blog posts found. Check back soon for updates!</p>
            </div>
          ) : (
            <div class="posts-list">
              {sortedPosts.map((post, index) => (
                <a
                  href={`/blog/${post.slug}`}
                  class="post-row"
                  data-tags={post.data.tags?.map((t) => t.toLowerCase()).join(",") ?? ""}
                >
                  <div class="post-thumbnail">
                    <img 
                      src={getPostImage(post)} 
                      alt={post.data.title}
                      loading={index < 3 ? "eager" : "lazy"}
                    />
                  </div>
                  <div class="post-info">
                    <div class="post-labels">
                      {post.data.companyName && (
                        <span class="badge badge-case-study">Case Study</span>
                      )}
                      {post.data.tags && post.data.tags.slice(0, 3).map((tag) => (
                        <span class="badge badge-tag">{tag}</span>
                      ))}
                    </div>
                    <h2 class="post-title">{post.data.title}</h2>
                    <p class="post-description">{post.data.description}</p>
                    <div class="post-meta">
                      <time datetime={post.data.publishDate.toISOString()}>
                        {formatDate(post.data.publishDate)}
                      </time>
                      <span class="meta-separator">•</span>
                      <span class="reading-time">{getReadingTime(post.body)}</span>
                      {post.data.author && (
                        <>
                          <span class="meta-separator">•</span>
                          <span class="author">{post.data.author}</span>
                        </>
                      )}
                    </div>
                  </div>
                  <div class="post-arrow">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                  </div>
                </a>
              ))}
            </div>
          )
        }
      </div>
    </section>
  </main>

  <script>
    const tagParam = "tag";

    function getTagFromUrl(): string {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get(tagParam);
      return raw ? raw.toLowerCase().trim() : "";
    }

    function setTagInUrl(tag: string): void {
      const url = new URL(window.location.href);
      if (tag) {
        url.searchParams.set(tagParam, tag);
      } else {
        url.searchParams.delete(tagParam);
      }
      window.history.replaceState({ tag }, "", url.toString());
    }

    function applyFilter(needle: string): void {
      const pillTags = Array.from(document.querySelectorAll(".blog-tag-filter .filter-pill")).map(
        (b) => ((b as HTMLButtonElement).dataset.tag ?? "").toLowerCase()
      );
      const validNeedle = needle && pillTags.includes(needle) ? needle : "";
      if (needle && !validNeedle) {
        setTagInUrl("");
      }
      document.querySelectorAll(".blog-tag-filter .filter-pill").forEach((b) => {
        const pillTag = (b as HTMLButtonElement).dataset.tag ?? "";
        const isActive = (pillTag.toLowerCase() === validNeedle) || (!validNeedle && pillTag === "");
        b.classList.toggle("active", isActive);
      });
      document.querySelectorAll(".posts-list .post-row").forEach((row) => {
        const tags = (row.getAttribute("data-tags") ?? "").split(",").filter(Boolean);
        const show = !validNeedle || tags.some((t) => t === validNeedle);
        (row as HTMLElement).style.display = show ? "" : "none";
      });
    }

    function initFromUrl(): void {
      const tag = getTagFromUrl();
      applyFilter(tag);
    }

    document.querySelectorAll(".blog-tag-filter .filter-pill").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const tag = (e.currentTarget as HTMLButtonElement).dataset.tag ?? "";
        const needle = tag.toLowerCase();
        setTagInUrl(needle);
        applyFilter(needle);
      });
    });

    initFromUrl();
  </script>

  <style lang="scss">
    @use "../../styles/mixins/typography" as *;
    @use "../../styles/mixins/breakpoints" as *;

    #blog-page {
      background-color: var(--surface-frame-bg);
    }

    .blog-posts-listing {
      padding: 2rem 0 5rem;
      background-color: #f5f5f5;

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .blog-tag-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding: 0.25rem 0;
      }

      .filter-pill {
        padding: 0.4rem 0.9rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-body-secondary, #555);
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 999px;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s, color 0.2s;

        &:hover {
          background: #f5f5f5;
          border-color: #ccc;
          color: var(--text-body-primary);
        }

        &.active {
          background: var(--primary-button-bg, #0c8ce0);
          border-color: var(--primary-button-bg, #0c8ce0);
          color: #fff;
        }
      }

      // Posts List
      .posts-list {
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      // Individual Post Row
      .post-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.25rem;
        padding: 1.5rem 0;
        background: transparent;
        text-decoration: none;
        color: inherit;
        border-bottom: 1px solid #e0e0e0;
        transition: background-color 0.2s ease;

        @include break-up(sm) {
          grid-template-columns: minmax(200px, 1fr) 2fr;
          gap: 2rem;
          padding: 2rem 0;
        }

        @include break-up(lg) {
          grid-template-columns: minmax(280px, 1fr) 2fr auto;
          gap: 2.5rem;
          padding: 2.5rem 0;
        }

        &:first-child {
          padding-top: 0;
        }

        &:last-child {
          border-bottom: none;
        }

        &:hover {
          .post-title {
            color: var(--primary-button-bg, #0c8ce0);
          }

          .post-thumbnail img {
            transform: scale(1.03);
          }

          .post-arrow svg {
            transform: translateX(6px);
            color: var(--primary-button-bg, #0c8ce0);
          }
        }

        .post-thumbnail {
          width: 100%;
          border-radius: 8px;
          overflow: hidden;
          background: #f5f5f5;
          flex-shrink: 0;

          img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
          }
        }

        .post-info {
          display: flex;
          flex-direction: column;
          justify-content: center;
          min-width: 0;
        }

        .post-labels {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          margin-bottom: 0.5rem;
        }

        .badge {
          display: inline-block;
          padding: 3px 10px;
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.4px;
          border-radius: 4px;
          white-space: nowrap;
        }

        .badge-case-study {
          background: #f0fdf4;
          color: #166534;
          border: 1px solid #bbf7d0;
        }

        .badge-tag {
          background: #f5f5f5;
          color: #555;
          border: 1px solid #e0e0e0;
        }

        .post-title {
          margin: 0 0 0.5rem;
          font-size: 1.25rem;
          font-weight: 500;
          line-height: 1.35;
          color: var(--text-body-primary);
          transition: color 0.2s ease;

          @include break-up(md) {
            font-size: 1.4rem;
          }
        }

        .post-description {
          margin: 0 0 1rem;
          font-size: 0.95rem;
          line-height: 1.6;
          color: var(--text-body-secondary, #555);
          font-weight: 300;

          @include break-up(md) {
            font-size: 1rem;
            // Clamp to 3 lines
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
          }
        }

        .post-meta {
          display: flex;
          align-items: center;
          flex-wrap: wrap;
          gap: 0.5rem;

          time {
            font-size: 13px;
            color: var(--text-body-secondary, #888);
            font-weight: 400;
          }

          .meta-separator {
            color: var(--text-body-secondary, #ccc);
            font-size: 13px;
          }

          .reading-time {
            font-size: 13px;
            color: var(--primary-button-bg, #0c8ce0);
            font-weight: 500;
          }

          .author {
            font-size: 13px;
            color: var(--text-body-secondary, #888);
            font-weight: 400;
          }
        }

        .post-arrow {
          display: none;
          color: var(--text-body-secondary, #ccc);
          align-self: center;

          @include break-up(lg) {
            display: flex;
            align-items: center;
          }

          svg {
            transition: transform 0.2s ease, color 0.2s ease;
          }
        }
      }

      // Empty State
      .no-posts {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 12px;

        p {
          @include typography(paragraph);
          color: var(--text-body-secondary);
        }
      }
    }
  </style>
</ProductLayout>
