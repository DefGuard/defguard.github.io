---
title: "DG25-23: OpenID apps remain authorized even after the scope change"
severity: Medium
cvss_score: 4.3
cvss_string: "/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N"
issue_link: https://github.com/DefGuard/defguard/issues/1520
status: Completed
---

### Technical details

Whenever user authorizes app for the first time - the /consent page is
being displayed which informs user which data the oAuth app will get
access:

**Request:**\
\
**GET**
`/api/v1/oauth/authorize?scope=groups&response_type=code&client_id=9szvHNlxY6R3jvbX&redirect_uri=https%3A%2F%2Fisec.pl&state=1&nonce=1&allow=true`
HTTP/2\
**Host:** defguard.dvpnsec.net\
**Cookie:** defguard_session=0i1uyyokye6n58A0mSLs1VQ7\
\
\
**Response:**\
\
**HTTP/2** 302 Found\
**Alt-Svc:** h3=\":443\"; ma=2592000\
**Date:** Mon, 11 Aug 2025 12:23:54 GMT\
**Location:**
/consent?scope=groups&response_type=code&client_id=9szvHNlxY6R3jvbX&redirect_uri=https%3A%2F%2Fisec.pl&state=1&nonce=1\
**Server:** Caddy\
**Content-Length:** 0

User has to click Accept button, below request is being sent and app
appears in the authorized app list:

**Request:**\
\
**POST**
`/api/v1/oauth/authorize?scope=groups&response_type=code&client_id=9szvHNlxY6R3jvbX&redirect_uri=https%3A%2F%2Fisec.pl&state=1&nonce=1&allow=true`
HTTP/2\
**Host:** defguard.dvpnsec.net\
**Cookie:** defguard_session=0i1uyyokye6n58A0mSLs1VQ7\
\[\...\]\
\
\
**Response:**\
\
**HTTP/2** 302 Found\
**Alt-Svc:** h3=\":443\"; ma=2592000\
**Date:** Mon, 11 Aug 2025 12:25:38 GMT\
**Location:** `https://isec.pl/?code=re7zcBKPEzSndmBmCIONytHj&state=1`\
\[\...\]

**Request:**\
\
**GET** /api/v1/user/user HTTP/2\
**Host:** defguard.dvpnsec.net\
**Cookie:** defguard_session=0i1uyyokye6n58A0mSLs1VQ7\
\
\
**Response:**\
\
**HTTP/2** 200 OK\
**Alt-Svc:** h3=\":443\"; ma=2592000\
**Content-Type:** application/json\
**Date:** Mon, 11 Aug 2025 12:26:38 GMT\
\[\...\]\

```json
{
  "user ": {
    "authorized_apps ": [
      {
        "oauth2client_id ": 8,
        "oauth2client_name ": "openid123 ",
        "user_id ": 59
      }
    ]
  }
}```

\[\...\]

However, when administrator changes the scope of the OpenID app, the
users who had that app authorized before, are still authorized it:

1.  Admin changes the scope of the app, extending the scope:

**Request:**\
\
**PUT** /api/v1/oauth/9szvHNlxY6R3jvbX HTTP/2\
**Host:** defguard.dvpnsec.net\
**Cookie:** defguard_session=KENMUulcmfVkD0W8MZjN4Rjw\
\[\...\]\

```json
{
  "client_secret ": "SHyMugRCmiTkLdo1xtV5IwgrY1dKoHpN ",
  "enabled ": true,
  "id ": 8,
  "name ": "openid123 ",
  "redirect_uri ": [
    "https://isec.pl "
  ],
  "scope ": [
    "phone ",
    "groups ",
    "email ",
    "profile ",
    "openid "
  ]
}
```
\
**Response:**\
\
**HTTP/2** 200 OK\
**Alt-Svc:** h3=\":443\"; ma=2592000\
**Content-Type:** application/json\
**Date:** Mon, 11 Aug 2025 12:28:21 GMT\
**Server:** Caddy\
**X-Defguard-Version:** 1.5.0-a29ac10\
**Content-Length:** 2\
\
{}

1.  The app is still authorized:

**Request:**\
\
**GET** /api/v1/user/user HTTP/2\
**Host:** defguard.dvpnsec.net\
**Cookie:** defguard_session=0i1uyyokye6n58A0mSLs1VQ7\
\
\
**Response:**\
\
**HTTP/2** 200 OK\
**Alt-Svc:** h3=\":443\"; ma=2592000\
**Content-Type:** application/json\
**Date:** Mon, 11 Aug 2025 12:29:21 GMT\
\[\...\]\

```json
{
  "user ": {
    "authorized_apps ": [
      {
        "oauth2client_id ": 8,
        "oauth2client_name ": "openid123 ",
        "user_id ": 59
      }
    ]
  }
}
```

\[\...\]

**Request:**\
\
**GET**
`/api/v1/oauth/authorize?scope=profile&response_type=code&client_id=9szvHNlxY6R3jvbX&redirect_uri=https%3A%2F%2Fisec.pl&state=1&nonce=1&allow=true`
HTTP/2\
**Host:** defguard.dvpnsec.net\
**Cookie:** defguard_session=0i1uyyokye6n58A0mSLs1VQ7\
\
\
**Response:**\
\
**HTTP/2** 302 Found\
**Alt-Svc:** h3=\":443\"; ma=2592000\
**Date:** Mon, 11 Aug 2025 12:29:52 GMT\
**Location:** `https://isec.pl/?code=f5PFSValuFj9LQShB9AcAiiK&state=1`\
**Server:** Caddy\
**Content-Length:** 0
